{% extends "base.html" %}

{% block title %}Admin Dashboard - AGENSTOCK{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>Admin Dashboard</h1>
        <p>Manage your AGENSTOCK application</p>
    </div>

    <!-- Admin Quick Stats -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalUsers">0</h3>
                <p>Total Users</p>
            </div>
            <div class="stat-trend positive" id="userTrend">
                +0%
            </div>
        </div>
        
        <div class="admin-stat-card">
            <div class="stat-icon">
                <i class="fas fa-comments"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalChats">0</h3>
                <p>Chat Sessions</p>
            </div>
        </div>
        
        <div class="admin-stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalPortfolios">0</h3>
                <p>Portfolios</p>
            </div>
        </div>
        
        <div class="admin-stat-card">
            <div class="stat-icon">
                <i class="fas fa-robot"></i>
            </div>
            <div class="stat-info">
                <h3 id="apiUsage">0</h3>
                <p>API Calls Today</p>
            </div>
        </div>
    </div>

    <!-- Admin Actions -->
    <div class="admin-actions">
        <h2>Quick Actions</h2>
        <div class="actions-grid">
            <a href="/admin/users" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-user-cog"></i>
                </div>
                <h3>User Management</h3>
                <p>Manage users and permissions</p>
            </a>
            
            <a href="/admin/analytics" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h3>Analytics</h3>
                <p>View application analytics</p>
            </a>
            
            {% if user.username == "admin" %}
        
            <div class="action-card" onclick="showCreateAdminModal()">
                <div class="action-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h3>Create Admin</h3>
                <p>Add new admin user</p>
            </div>
            {% endif %}
            
            <div class="action-card" onclick="viewApiStatus()">
                <div class="action-icon">
                    <i class="fas fa-key"></i>
                </div>
                <h3>API Status</h3>
                <p>Check API key usage</p>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity">
        <h2>Recent User Activity</h2>
        <div class="activity-table-container">
            <table class="activity-table" id="recentActivityTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Activity</th>
                        <th>Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="activityTableBody">
                    <!-- Activity will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- System Status -->
    <div class="system-status">
        <h2>System Status</h2>
        <div class="status-grid">
            <div class="status-card">
                <h3>Database</h3>
                <div class="status-indicator online"></div>
                <span>Connected</span>
            </div>
            <div class="status-card">
                <h3>AI Service</h3>
                <div class="status-indicator online"></div>
                <span>Operational</span>
            </div>
            <div class="status-card">
                <h3>Stock Data</h3>
                <div class="status-indicator online"></div>
                <span>Live</span>
            </div>
            <div class="status-card">
                <h3>Email Service</h3>
                <div class="status-indicator online"></div>
                <span>Ready</span>
            </div>
        </div>
    </div>
</div>

<!-- Create Admin Modal -->
<div class="modal-overlay" id="createAdminModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Admin User</h3>
            <button class="modal-close" onclick="hideCreateAdminModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="createAdminForm">
            <div class="form-group">
                <label for="adminUsername">Username</label>
                <input type="text" id="adminUsername" name="username" required>
            </div>
            
            <div class="form-group">
                <label for="adminEmail">Email</label>
                <input type="email" id="adminEmail" name="email" required>
            </div>
            
            <div class="form-group">
                <label for="adminFullName">Full Name</label>
                <input type="text" id="adminFullName" name="full_name">
            </div>
            
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" name="password" required>
            </div>
            
            <div class="form-group">
                <label for="adminConfirmPassword">Confirm Password</label>
                <input type="password" id="adminConfirmPassword" name="confirm_password" required>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideCreateAdminModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Admin</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadAdminStats();
    loadRecentActivity();
    setInterval(loadAdminStats, 30000); // Poll every 30 seconds for real-time stats
});

async function loadAdminStats() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/admin/analytics/data', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            updateAdminStats(data);
        }
    } catch (error) {
        console.error('Failed to load admin stats:', error);
    }
}

function updateAdminStats(data) {
    document.getElementById('totalUsers').textContent = data.user_metrics.total_users;
    document.getElementById('totalChats').textContent = data.chat_metrics.total_chats;
    document.getElementById('totalPortfolios').textContent = data.portfolio_metrics.total_portfolios;
    
    // Calculate user trend
    const trend = data.user_metrics.new_users_today > 0 ? '+' + data.user_metrics.new_users_today : '0';
    document.getElementById('userTrend').textContent = trend + '%';
}

async function loadRecentActivity() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/admin/recent-activity', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            const activityData = await response.json();
            // Normalize times to human-friendly relative strings where possible (fallback to provided)
            const normalized = activityData.map(a => ({
                user: a.user || 'system',
                activity: a.activity || '',
                time: a.time ? new Date(a.time).toLocaleString() : 'Just now',
                status: a.status || 'info'
            }));
            updateActivityTable(normalized);
        } else {
            throw new Error('Failed to load recent activity');
        }
    } catch (err) {
        console.error('Failed to load recent activity', err);
        // Fallback to sample data so UI isn't empty
        const activityData = [
            { user: 'system', activity: 'No recent activity available', time: 'Now', status: 'info' }
        ];
        updateActivityTable(activityData);
    }
}

function updateActivityTable(activities) {
    const tableBody = document.getElementById('activityTableBody');
    
    tableBody.innerHTML = activities.map(activity => `
        <tr>
            <td class="user-cell">
                <i class="fas fa-user"></i>
                ${activity.user}
            </td>
            <td>${activity.activity}</td>
            <td>${activity.time}</td>
            <td>
                <span class="status-badge ${activity.status}">
                    ${activity.status.charAt(0).toUpperCase() + activity.status.slice(1)}
                </span>
            </td>
        </tr>
    `).join('');
}

function showCreateAdminModal() {
    document.getElementById('createAdminModal').style.display = 'flex';
}

function hideCreateAdminModal() {
    document.getElementById('createAdminModal').style.display = 'none';
    document.getElementById('createAdminForm').reset();
}

document.getElementById('createAdminForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const adminData = {
        username: formData.get('username'),
        email: formData.get('email'),
        full_name: formData.get('full_name'),
        password: formData.get('password')
    };
    
    // Validate password confirmation
    if (formData.get('password') !== formData.get('confirm_password')) {
        alert('Passwords do not match');
        return;
    }
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/admin/create-admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(adminData)
        });
        
        if (response.ok) {
            alert('Admin user created successfully!');
            hideCreateAdminModal();
        } else {
            const error = await response.json();
            alert('Failed to create admin: ' + error.detail);
        }
    } catch (error) {
        alert('Failed to create admin: ' + error.message);
    }
});

function viewApiStatus() {
    alert('API Status feature would show current API key usage and limits');
}
</script>

<style>
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.admin-header {
    text-align: center;
    margin-bottom: 3rem;
}

.admin-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.admin-stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    display: flex;
    align-items: center;
    gap: 1rem;
    position: relative;
}

.admin-stat-card .stat-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.stat-trend {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.stat-trend.positive {
    background: var(--success-color);
    color: white;
}

.stat-trend.negative {
    background: var(--danger-color);
    color: white;
}

.admin-actions {
    margin-bottom: 3rem;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.action-card {
    background: white;
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    text-align: center;
    text-decoration: none;
    color: inherit;
    transition: var(--transition);
    cursor: pointer;
}

.action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}

.action-card .action-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
    margin: 0 auto 1rem;
}

.action-card h3 {
    margin-bottom: 0.5rem;
    color: var(--dark-color);
}

.action-card p {
    color: var(--gray-color);
    margin: 0;
}

.recent-activity {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 2rem;
    margin-bottom: 3rem;
}

.activity-table-container {
    overflow-x: auto;
}

.activity-table {
    width: 100%;
    border-collapse: collapse;
}

.activity-table th,
.activity-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.activity-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: var(--dark-color);
}

.user-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-badge.success {
    background: var(--success-color);
    color: white;
}

.status-badge.warning {
    background: var(--warning-color);
    color: white;
}

.status-badge.error {
    background: var(--danger-color);
    color: white;
}

.system-status {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 2rem;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.status-card {
    text-align: center;
    padding: 1.5rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
}

.status-card h3 {
    margin-bottom: 1rem;
    color: var(--dark-color);
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin: 0 auto 0.5rem;
}

.status-indicator.online {
    background: var(--success-color);
}

.status-indicator.offline {
    background: var(--danger-color);
}

.status-indicator.warning {
    background: var(--warning-color);
}
</style>
{% endblock %}